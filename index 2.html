<html>
<head>
<script src="./js/jquery.min.js"></script>
<script type='text/javascript' src='js/config.js'></script>
<script src="js/airtable/airtable.browser.js"></script>
<script src='//w.soundcloud.com/player/api.js'></script>

<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.0-beta1/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-0evHe/X+R7YkIZDRvuzKMRqM+OrBnVFBL6DOitfPri4tjfHxaWutUpFmBp4vmVor" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.8.3/font/bootstrap-icons.css">

<link rel="stylesheet" href="./style.css">


<title>Brad Songs</title>
</head>

<body>

<div class="container sticky-top bg-light">
    <header class="d-flex justify-content-center py-3">
      <ul class="nav nav-pills">
        <li class="nav-item" id="byprompt"><a href="#" class="nav-link">Browse by Prompts</a></li>
        <li class="nav-item" id="byartist"><a href="#" class="nav-link">Browse by Artists</a></li>
      </ul>
    </header>
  </div>

  <div class="px-4 py-5 my-5 text-center headline-container">
    <h1 class="display-5 fw-bold">Brad Songs</h1>
    <div class="col-lg-6 mx-auto">
      <p class="lead mb-4">"it's this dumb thing where one of us in the group posts a new comment that is a topic or song title or something, and then people in the group make some sort of audio thing about it. maybe a weird soundscape or a low fi pop song. and then you post it when you make it and everyone likes to hear it." <br><br>-Trent Urness</p>
    </div>
  </div>


<div class="data">
	<div class="container">
		<div class="search">
			<div id="firstlist" class="accordion">
			</div>
		</div>
	</div>

</div>

<div class="player">
  <span class='playerinfo'></span>
  <div class="playerwaveform"></div>
  <div class="playerposition"></div>
</div>

<div class="container">
  <footer class="py-3 my-4">
    <p class="text-center text-muted">There are currently <span id="songcount" class="count">00</span> bradsongs by <span id="artistcount" class="count">00</span> artists from <span id="promptcount" class="count">00</span> prompts.</p>
  </footer>
</div>

<div id="widgetcontainer"><iframe class="sc-widget"></iframe></div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.2.0-beta1/dist/js/bootstrap.bundle.min.js" integrity="sha384-pprn3073KE6tl6bjs2QrFaJGz5/SUsLqktiwsUTF55Jfv3qYSDhgCecCxMW52nD2" crossorigin="anonymous"></script>

</body>
</html>

<script>
var Airtable = require('airtable');
var base = new Airtable({ apiKey: config.airtablekey }).base(config.dbkey);
var allsongs;
var allprompts;
var allartist;

//get the counts for the intro page



$( document ).ready(function() {

	//load the song list to count it and replace the footer
	base('song').select().eachPage(function page(records, fetchNextPage) {
	    fetchNextPage();
		allsongs=records;
		songcount = allsongs.length;
		$('#songcount').text(songcount);

	}, function done(err) {
	    if (err) { console.error(err); return; }
	});

	//load the prompt list to count it and replace the footer
	base('prompt').select().eachPage(function page(records, fetchNextPage) {
	    fetchNextPage();
		allprompts=records;
		promptcount = allprompts.length;
		$('#promptcount').text(promptcount);

	}, function done(err) {
	    if (err) { console.error(err); return; }
	});

	//load the artist list to count it and replace the artist
	base('artist').select().eachPage(function page(records, fetchNextPage) {
	    fetchNextPage();
		allartists=records;
		artistcount = allartists.length;
		$('#artistcount').text(artistcount);

	}, function done(err) {
	    if (err) { console.error(err); return; }
	});
});


//load a list of prompts when button clicked

$('#byprompt').click(function() {

	//hide the nonsense, show the goods
	$('.headline-container').hide();
	$('.search').show();


	//set bg color to active and empty the #firstlist
	$('button').removeClass("active");
	$(this).addClass("active");
	$('#firstlist').empty();
	$('#secondlist').empty();

	//call a list from the db
	    allprompts.forEach(function(record) {
			var prompt = record.get('prompt');
			var type = record.get('type');
			var url = record.get('url');
			var promptby = record.get('promptby');
			var promptdate = record.get('date');
			var songs = record.get('songs');


			//write prompts into html
			if (type == 'link') {
				$('#firstlist').append('<a href="#' + record.id + '" class="accordion-button" data-bs-toggle="collapse" data-bs-target="#' + record.id + '"><h4><span class="link">' + prompt + '</span><span onclick="window.open(\'' + url + '\', \'_blank\');"><i class="bi bi-box-arrow-up-right"></i></span></h4><p class="moreinfo">Prompt by ' + promptby + ' on ' + promptdate + '</p></a><ul class="accordion-collapse list-group secondlist collapse" id="' + record.id + '" data-bs-parent="#firstlist"></ul>');
			}
			else if ( type == 'image' ) {
				var promptlong = prompt.replace('small','large');
				$('#firstlist').append('<a href="#' + record.id + '" class="accordion-button" data-bs-toggle="collapse" data-bs-target="#' + record.id + '"><h4><img src="' + prompt + '" data-src="' + promptlong + '"   ></h4><p class="moreinfo">Prompt by ' + promptby + ' on ' + promptdate + '</p></a><ul class="accordion-collapse list-group secondlist collapse" id="' + record.id + '" data-bs-parent="#firstlist"></ul>');
			}
			else {
				$('#firstlist').append('<a href="#' + record.id + '" class="accordion-button" data-bs-toggle="collapse" data-bs-target="#' + record.id + '"><h4><span >' + prompt + '</span></h4><p class="moreinfo">Prompt by ' + promptby + ' on ' + promptdate + '</p></a><ul class="accordion-collapse list-group secondlist collapse" id="' + record.id + '" data-bs-parent="#firstlist"></ul>');
			}

			//write songs into collapsed lists after each prompt

			$.each(songs, function(k,songid) {
				// allsongs.find(songid, function(err, songrecord) {
				songrecord=allsongs.find(el => el.id === songid);
					var songurl = songrecord.get('url');
					var songtitle = songrecord.get('title');
					var songprompt = songrecord.get('prompt');
					var songartist = songrecord.get('artist');

					//instead of the URL-iFrame based function, we try to make a list from the db
					$('#' + record.id).append('<li class="list-group-item" title=\"' + songurl + '\" id=\"' + songid + '\"><p class=\"title\"><i class="bi bi-file-music"></i>' + songtitle + '</p><p class=\"songinfo\">Artist: ' + songartist + ', Prompt: ' + songprompt + '</p></li>');
				});
				//ok, that second list is populated too.

			});


			$('.moreinfo').hide();

			//excellent, our list is populated. now make a second list based on a #firstlist click.

		$('#firstlist a').click(function() {
			//set bg color to active and empty the second list
			$('#firstlist a').removeClass('active');
			$(this).addClass('active');
			$('.results').show();
			$('.moreinfo').hide();
			$('.moreinfo', this).show();


		});
});
//end of byprompt click function

$('#byartist').click(function() {

	//hide the nonsense, show the goods
	$('.headline-container').hide();
	$('.search').show();

	//set bg color to active and empty the #firstlist
	$('button').removeClass("active");
	$(this).addClass("active");
	$('#firstlist').empty();


	//call a list from the db
		allartists.forEach(function(record) {
			var artist = record.get('artist');
			var songs = record.get('songs')

			//write artists into html
			$('#firstlist').append('<a href="#' + record.id + '" class="accordion-button" data-bs-toggle="collapse" data-bs-target="#' + record.id + '"><h4><i class="bi bi-arrow-right-circle-fill"></i>' + artist + '</h4></a><ul class="accordion-collapse list-group secondlist collapse" id="' + record.id + '" data-bs-parent="#firstlist"></ul>');

						//write songs into collapsed lists after each prompt

			$.each(songs, function(k,songid) {
				// allsongs.find(songid, function(err, songrecord) {
				songrecord=allsongs.find(el => el.id === songid);
					var songurl = songrecord.get('url');
					var songtitle = songrecord.get('title');
					var songprompt = songrecord.get('prompt');
					var songartist = songrecord.get('artist');

					//instead of the URL-iFrame based function, we try to make a list from the db
					$('#' + record.id).append('<li class="list-group-item" title=\"' + songurl + '\" id=\"' + songid + '\"><p class=\"title\"><i class="bi bi-file-music"></i>' + songtitle + '</p><p class=\"songinfo\">Artist: ' + songartist + ', Prompt: ' + songprompt + '</p></li>');
				});
				//ok, that second list is populated too.


		});
		//now we have a populated #firstlist. time to make a second list.

		$('#firstlist a').click(function() {
			//set bg color to active
			$('#firstlist a').removeClass('active');
			$(this).addClass('active');
			$('.results').show();




			});

});

//now we should listen for a click on that second list.

$('#firstlist').on('click', '.secondlist li', function() {
	$('.secondlist li').removeClass('active');
	$(this).addClass('active');

	$('.player').show();

	var songurl = $(this).attr('title');
	$('#widgetcontainer').html('<iframe class="sc-widget" width="100%" height="166" scrolling="no" frameborder="no" src="https://w.soundcloud.com/player/?url=https%3A//api.soundcloud.com/tracks/' + songurl + '&amp;color=ff5500&amp;auto_play=false&amp;hide_related=true&amp;show_comments=false&amp;show_user=true&amp;show_reposts=false" allow="autoplay"></iframe>');
	widget();
});


// CUSTOM PLAYER STUFF

function widget() {

  var player = SC.Widget($('iframe.sc-widget')[0]);
  var pOffset = $('.player').offset();
  var pWidth = $('.player').width();
  var scrub;

  player.bind(SC.Widget.Events.READY, function() {
    setInfo(player);
    player.play();
  }); //Set info on load

  player.bind(SC.Widget.Events.PLAY_PROGRESS, function(e) {
    if( e.relativePosition < 0.003 ) { setInfo(player); }
    //Event listener when track is playing
    $('.playerposition').css('width', ( e.relativePosition*100)+"%");
  });

   $('.player').mousemove(function(e){ //Get position of mouse for scrubbing
    scrub = (e.pageX-pOffset.left);
  });

  $('.player').click(function(){ //Use the position to seek when clicked
    	$('.playerposition').css('width',scrub+"px");
		var seek = player.duration*(scrub/pWidth);

    	//Seeking to the start would be a previous?
		if ( seek < player.duration * .05 ) {
			player.prev();
		} else if ( seek > player.duration * .99 ) {
			player.next();
		} else {
			player.seekTo(seek);
		}
   });
}

function setInfo(player) {
	player.getCurrentSound(function(song) {

	 // Soundcloud just borked this api endpoint, hence this hack :/
		var waveformPng =
		song.waveform_url
		.replace('json', 'png')
		.replace('wis', 'w1');

	  	var artworkUrl = song.artwork_url || '';

	    console.log(song);

	  	$('.playerwaveform').css('background-image', "url('" + waveformPng + "')");
	  	$('.player').css('background-image', "url('" + artworkUrl.replace('-large', '-t500x500') + "')");

		var info = song.title;
		var artist = song.artist;
		$('.playerinfo').html(info);

		player.current = song;
    });

	player.getDuration(function(value){
		player.duration = value;
	});

	player.isPaused(function(bool){
		player.getPaused = bool;
	});
}

</script>